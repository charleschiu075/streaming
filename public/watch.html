<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>觀看直播</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #1a1a1a;
    color: white;
    margin: 0;
    padding: 20px;
}
.container {
    max-width: 1200px;
    margin: 0 auto;
}
h2 {
    text-align: center;
    color: #fff;
    margin-bottom: 30px;
}
.search-section {
    background: #2d2d2d;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
}
.search-group {
    display: flex;
    gap: 10px;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
}
input[type="text"] {
    padding: 12px;
    border: 2px solid #555;
    border-radius: 5px;
    font-size: 16px;
    background: #1a1a1a;
    color: white;
    min-width: 250px;
}
input[type="text"]:focus {
    outline: none;
    border-color: #007bff;
}
button {
    background: #007bff;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
}
button:hover {
    background: #0056b3;
}
button:disabled {
    background: #555;
    cursor: not-allowed;
}
.video-section {
    background: #2d2d2d;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
}
video {
    max-width: 100%;
    height: auto;
    border-radius: 10px;
    background: #000;
}
.video-placeholder {
    width: 100%;
    height: 360px;
    background: #000;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    font-size: 18px;
    border: 2px dashed #555;
}
.status {
    margin: 15px 0;
    padding: 10px;
    border-radius: 5px;
    text-align: center;
}
.status.loading {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}
.status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
.status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
.stream-info {
    background: #343a40;
    padding: 15px;
    border-radius: 5px;
    margin-top: 15px;
    text-align: left;
    font-size: 14px;
}
.controls {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}
.control-btn {
    background: #28a745;
    padding: 8px 16px;
    font-size: 14px;
}
.control-btn.stop {
    background: #dc3545;
}
.links {
    text-align: center;
    margin-top: 30px;
}
.links a {
    color: #007bff;
    text-decoration: none;
    margin: 0 15px;
}
.links a:hover {
    text-decoration: underline;
}
</style>
</head>
<body>
<div class="container">
    <h2>觀看直播</h2>
    
    <div class="search-section">
        <h3>輸入直播主帳號</h3>
        <div class="search-group">
            <input type="text" id="usernameInput" placeholder="輸入直播使用者帳號" />
            <button onclick="loadStream()" id="playBtn">播放</button>
        </div>
    </div>
    
    <div class="video-section">
        <div id="videoContainer">
            <div class="video-placeholder" id="placeholder">
                請輸入直播主帳號並點擊播放
            </div>
            <video id="video" width="640" height="360" controls style="display: none;"></video>
        </div>
        
        <div id="status"></div>
        
        <div class="controls" id="controls" style="display: none;">
            <button class="control-btn" onclick="playStream()">播放</button>
            <button class="control-btn" onclick="pauseStream()">暫停</button>
            <button class="control-btn stop" onclick="stopStream()">停止</button>
            <button class="control-btn" onclick="toggleMute()">靜音/取消靜音</button>
        </div>
        
        <div class="stream-info" id="streamInfo" style="display: none;">
            <div><strong>串流網址：</strong> <span id="streamUrl"></span></div>
            <div><strong>狀態：</strong> <span id="streamStatus">就緒</span></div>
        </div>
    </div>
    
    <div class="links">
        <a href="login.html">登入</a>
        <a href="register.html">註冊</a>
        <a href="dashboard.html">控制台</a>
    </div>
</div>

<script>
// 全域變數
let hls = null;
let currentUsername = null;
let streamCheckInterval = null;
const HOSTIP = "3.107.21.209";
const STREAM_CHECK_INTERVAL = 10000; // 10秒檢查一次串流狀態
const MAX_RETRY_COUNT = 3; // 最大重試次數
let retryCount = 0;

// 顯示訊息
function showStatus(message, type = 'loading') {
    const statusDiv = document.getElementById('status');
    if (!statusDiv) return;
    
    statusDiv.textContent = message;
    statusDiv.className = `status ${type}`;
    statusDiv.style.display = 'block';
}

// 隱藏訊息
function hideStatus() {
    const statusDiv = document.getElementById('status');
    if (!statusDiv) return;
    
    statusDiv.style.display = 'none';
}

// 顯示串流資訊
function showStreamInfo(username, streamUrl) {
    const streamUrlElement = document.getElementById('streamUrl');
    const streamStatusElement = document.getElementById('streamStatus');
    const streamInfoElement = document.getElementById('streamInfo');
    
    if (!streamUrlElement || !streamStatusElement || !streamInfoElement) return;
    
    streamUrlElement.textContent = streamUrl;
    streamStatusElement.textContent = '連接中...';
    streamInfoElement.style.display = 'block';
}

// 更新串流狀態
function updateStreamStatus(status) {
    const statusElement = document.getElementById('streamStatus');
    if (!statusElement) return;
    
    statusElement.textContent = status;
}

// 顯示影片播放器
function showVideo() {
    const placeholder = document.getElementById('placeholder');
    const video = document.getElementById('video');
    const controls = document.getElementById('controls');
    
    if (!placeholder || !video || !controls) return;
    
    placeholder.style.display = 'none';
    video.style.display = 'block';
    controls.style.display = 'flex';
}

// 隱藏影片播放器
function hideVideo() {
    const placeholder = document.getElementById('placeholder');
    const video = document.getElementById('video');
    const controls = document.getElementById('controls');
    const streamInfo = document.getElementById('streamInfo');
    
    if (!placeholder || !video || !controls || !streamInfo) return;
    
    placeholder.style.display = 'flex';
    video.style.display = 'none';
    controls.style.display = 'none';
    streamInfo.style.display = 'none';
}

// 檢查串流狀態
async function checkStreamStatus(username) {
    if (!username) return false;
    
    try {
        const response = await fetch(`/api/stream/public/${username}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.data.isStreaming) {
            updateStreamStatus('直播中');
            return true;
        } else {
            updateStreamStatus('未開播');
            return false;
        }
    } catch (error) {
        console.error('檢查串流狀態失敗:', error);
        updateStreamStatus('狀態檢查失敗');
        return false;
    }
}

// 開始定期檢查串流狀態
function startStreamCheck(username) {
    if (!username) return;
    
    // 清除現有的檢查間隔
    if (streamCheckInterval) {
        clearInterval(streamCheckInterval);
    }
    
    // 立即檢查一次
    checkStreamStatus(username);
    
    // 設定定期檢查
    streamCheckInterval = setInterval(() => {
        checkStreamStatus(username);
    }, STREAM_CHECK_INTERVAL);
}

// 停止定期檢查
function stopStreamCheck() {
    if (streamCheckInterval) {
        clearInterval(streamCheckInterval);
        streamCheckInterval = null;
    }
}

// 初始化 HLS 播放器
function initHLS(video, streamUrl) {
    if (hls) {
        hls.destroy();
        hls = null;
    }

    if (Hls.isSupported()) {
        hls = new Hls({
            debug: false,
            enableWorker: true,
            lowLatencyMode: true,
            backBufferLength: 90
        });

        hls.loadSource(streamUrl);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, () => {
            console.log('HLS 串流已準備就緒');
            video.play().catch(e => {
                console.error('自動播放失敗:', e);
                showStatus('請點擊播放按鈕開始播放', 'info');
            });
        });

        hls.on(Hls.Events.ERROR, (event, data) => {
            console.error('HLS 錯誤:', data);
            if (data.fatal) {
                switch (data.type) {
                    case Hls.ErrorTypes.NETWORK_ERROR:
                        console.log('網路錯誤，嘗試恢復...');
                        hls.startLoad();
                        break;
                    case Hls.ErrorTypes.MEDIA_ERROR:
                        console.log('媒體錯誤，嘗試恢復...');
                        hls.recoverMediaError();
                        break;
                    default:
                        console.log('無法恢復的錯誤');
                        stopStream();
                        showStatus('串流載入失敗，請重試', 'error');
                        break;
                }
            }
        });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // 對於 Safari 等原生支援 HLS 的瀏覽器
        video.src = streamUrl;
        video.addEventListener('loadedmetadata', () => {
            video.play().catch(e => {
                console.error('自動播放失敗:', e);
                showStatus('請點擊播放按鈕開始播放', 'info');
            });
        });
    } else {
        showStatus('您的瀏覽器不支援 HLS 串流', 'error');
    }
}

// 載入串流
async function loadStream() {
    const usernameInput = document.getElementById("usernameInput");
    if (!usernameInput) return;
    
    const username = usernameInput.value.trim();
    
    if (!username) {
        showStatus("請輸入直播主帳號", "error");
        return;
    }
    
    try {
        const response = await fetch(`/api/stream/public/${username}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            showStatus("找不到該直播主", "error");
            return;
        }

        const video = document.getElementById("video");
        if (!video) return;
        
        const streamUrl = `http://${HOSTIP}:8000/live/${username}/index.m3u8`;
        
        currentUsername = username;
        showStatus("正在載入直播...", "loading");
        showStreamInfo(username, streamUrl);
        
        // 初始化 HLS 播放器
        initHLS(video, streamUrl);
        
        // 開始定期檢查串流狀態
        startStreamCheck(username);
        
        // 顯示影片播放器
        showVideo();
        
        // 重置重試計數
        retryCount = 0;
        
    } catch (error) {
        console.error('載入串流失敗:', error);
        showStatus("載入串流失敗，請重試", "error");
        
        // 重試機制
        if (retryCount < MAX_RETRY_COUNT) {
            retryCount++;
            setTimeout(() => {
                loadStream();
            }, 2000);
        }
    }
}

// 播放控制函數
function playStream() {
    const video = document.getElementById("video");
    if (!video) return;
    
    video.play().catch(e => {
        console.error("播放失敗:", e);
        showStatus("播放失敗", "error");
    });
}

function pauseStream() {
    const video = document.getElementById("video");
    if (!video) return;
    
    video.pause();
}

function stopStream() {
    const video = document.getElementById("video");
    if (!video) return;
    
    video.pause();
    video.currentTime = 0;
    
    if (hls) {
        hls.destroy();
        hls = null;
    }
    
    // 停止定期檢查
    stopStreamCheck();
    
    hideVideo();
    hideStatus();
    currentUsername = null;
}

function toggleMute() {
    const video = document.getElementById("video");
    if (!video) return;
    
    video.muted = !video.muted;
}

// 處理頁面載入
window.addEventListener("load", () => {
    const params = new URLSearchParams(window.location.search);
    const userFromQuery = params.get("user");
    if (userFromQuery) {
        const input = document.getElementById("usernameInput");
        if (input) {
            input.value = userFromQuery;
            loadStream();
        }
    }
});

// 處理頁面卸載
window.addEventListener('beforeunload', () => {
    stopStreamCheck();
    if (hls) {
        hls.destroy();
        hls = null;
    }
});

// Enter 鍵快捷播放
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && document.getElementById('usernameInput') === document.activeElement) {
        loadStream();
    }
});

// 獲取串流資訊
async function getStreamInfo() {
  const username = new URLSearchParams(window.location.search).get('username');
  if (!username) {
    showMessage('無效的串流地址');
    return;
  }

  try {
    const res = await fetch(`http://3.107.21.209:8000/api/stream/info/${username}`);
    const data = await res.json();

    if (data.success) {
      document.getElementById('streamTitle').textContent = data.data.title || `${username} 的直播`;
      document.getElementById('streamerName').textContent = username;
      
      // 更新串流地址
      const hlsUrl = `http://3.107.21.209:8000/hls/${username}/index.m3u8`;
      const dashUrl = `http://3.107.21.209:8000/dash/${username}/index.mpd`;
      
      // 設置 HLS 播放器
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(hlsUrl);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          video.play();
        });
      }
      // 設置 DASH 播放器
      else if (dashjs.supportsMediaSource()) {
        const player = dashjs.MediaPlayer().create();
        player.initialize(video, dashUrl, true);
      }
      // 原生播放器
      else {
        video.src = hlsUrl;
      }
    } else {
      showMessage(data.message || '無法獲取串流資訊');
    }
  } catch (error) {
    console.error('獲取串流資訊錯誤:', error);
    showMessage('獲取串流資訊失敗，請稍後再試');
  }
}
</script>
</body>
</html>